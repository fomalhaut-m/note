# 会话

### 会话功能

> 所有的对话都称之为会话
> 约定 会话ID = 0 为公告

#### --------操作--------

- 1.新建会话
- 2.群组加人
- 3.群组踢人
- 4.群组删除
- 5.退出群聊
- 6.会话顶置
- 7.会话勿扰
- 8.禁言/解禁
- 10.清除未读计数
- 11.发送信息
- 12.标记已读

#### --------查询--------

- 会话列表查询
- 会话内容查询
- 查看用户信息
- 会话消息查询

#### --------推送---------

- 推送信息

## 1. Q 会话列表

POST/imSession/search

1. 查询个人会话消息（包括群组消息）列表；
2. 向会话列表中添加“公告消息”会话（插入第一个位置，公告通知会话不入库，ID=0，标题与图标等其它信息均固定死）；
3. 返回列表：数据格式按照前端要求返回；默认显示一条公告通知置顶；
   
   ## 2. Q 会话内容查询
   
   POST/imSession/searchContent
   
   ## 3. 清除未读计数
   
   POST/imSession/clearUnread
   
   ## 4. 标记己读
   
   POST/imSession/setReadSign
   
   ## 5. 发送消息
   
   POST/imSession/sendMsg
- **使用场景：**
  - 个人登录后，会话消息或会话群组发送消息。发送消息后（消息长度小于等于1Kb），进行发送通知，消息通知展示在页面右下角，展示3秒小时；
    消息接收人点击弹框或在跟人消息列表打开消息。
- **接口逻辑：**
  1. 将消息内容及相关属性填入模板，组装消息内容；
  2. 发送前将消息存入数据库，消息状态 待发送；
  3. 消息发送后，更新消息状态 发送成功、发送失败
     1. 发送成功：发送人消息保存；接收人消息保存；
     2. 发送失败：发送人消息保存；接收人消息不保存；
  4. 消息发送成功：接收人打开当前消息对话框，消息标记为已读；
  5. 当前窗口未打开，消息状态为未读；
     
     ## 6. Q 推送前端
     
     POST/loadMsg
1. 打开会话窗口 - 消息标记为已读
2. 未打开会话窗口 - 消息状态为未读
3. 接收消息按照模板进行展示
   
   ## 7. Q 会话详情
   
   POST/imSession/detail
4. 根据用户查询当前会话聊天记录；查询近10天内容（不分页）
5. 根据会话查询当前会话成员信息（数组）
   
   ## 8. 会话新建
   
   POST/imSession/create
- **使用场景：**
  会话新建，个人需要发起点对点会话、会话添加人后创建会话群组。
- **接口逻辑：**
  1. 会话已存在，不能创建
  2. 不存在：则创建会话或会话群组
  3. 不同类型处理
     1. 点对点会话
        点对点会话，直接创建聊天窗口，会话人为当前用户和聊天人；创建socket connection;
     2. 对点会话添加人，创建新会话群组
        在现有点对点会话基础上创建新的会话群组；会话群组需要拉入原有点对点会话双人，还有新添加的人；创建socket connection;
     3. 群组会话
        直接创建群组会话，选择多人，创建群组会话；（规则：超过三人，创建会话既为会话群组）；创建socket connection;

| 会话类型    | 参与人集合 | 会话名称         |
| ------- | ----- | ------------ |
| 点对点     | 一个身份  | 目标身份的名称      |
| 点对点创建群组 | 身份集合  | 用户定义(**必填**) |
| 群组      | 身份集合  | 用户定义(**必填**) |

## 9. 会话删除：解散群组

POST/imSession/delete

## 10. 会话加人(支持批量)

POST/imSession/addPerson

- 接口逻辑
  - 查询加入的会话信息；
    - 存在
      - 会话加人：
        - 添加会话聊天人，将会话聊天id和信息添加到当前会话聊天人的数据记录中；
        - 批量更新：
        - 会话群组中每个人的会话信息进行更新，添加会话新增聊天人id和名称；
    - 不存在 throw Exception;返回错误码和信息；加人通知
      - 加入完成后，通知所有人
        
        ## 11. 会话删人(支持批量)
        
        POST/imSession/deletePerson
- **使用场景**
  - 会话群组的群组leader拥有删除群组成员的权限，可以移除会话群组成员；
  - 群组leader可以批量移除，并解散群组；
- **接口逻辑**
  - if 根据要删除的会话id查询会话是否不存在或无效；
    - throw Exception 提示当前会话不存在
  - else 会话存在或有效
    - query 查询要移除的会话群组成员是否存在；
  - **if 存在**
    - 则移除会话成员；可以批量进行进行删除；移除操作则更新当前会话人的会话聊天人，将其移除；
    - 如果全部移除，则解散会话。删除会话：实际是对会话状态的status进行更新为-1，执行假删除；
  - **else 不存在**
    - 当前移除的会话、会话成员不存在
- 接口throw Exception 返回信息：
  - 当前移除的会话、会话成员不存在。
- 删人通知
  - 删除群组成员后，会应用会话成员后，通知所有人
    
    ## 12. 会话置顶
    
    POST/imSession/top
- **使用场景：**
  - 该接口主要用于会话消息或会话群组置顶显示；
- 算法思想
  - 置顶会话默认都为0 设置置顶则取  max(priority=0) +1;
  - 相同会话权值 按照时间戳进行倒排；  order by priority ，timestamp desc;
- 接口逻辑：
  - 查询置顶会话是否存在
    - if 存在
      - 取最大权值+1
    - else 不存在
      - throw Exception 提示置顶的会话不存在。
    - 优先按照权值排序，相同权值则按照时间倒排；
      
      ## 13. 勿扰设置
      
      POST/imSession/disturb
- 使用场景
  - 设置会话为免打扰，不提示会话消息
- 设置免打扰标识 update免打扰字段 dntFlag 为1
  
  ## 14. 禁言解禁
  
  POST/imSession/speakingNotAllowed
1. 禁言后将身份成员添加到blackList  ；
2. 取消禁言则从会话配置黑名单中移除，恢复发言。
   黑名单用户不可发言。
   
   ## 15. 退出群聊
   
   POST/imSession/quit
- 使用场景
  - 个人主动退出群聊；
    1. 退出群聊则消息会话进行更新，更新每个会话成员的会话群组成员信息；
    2. 群leader重新指定，按照加入群聊时间进行指定leader;
- 接口逻辑
  - if 不存在
    - 退出失败：throw Exception 返回信息提示会话群组不存在，操作失败
  - else 存在
    - 将个人会话群组状态status 进行删除，假删除 update status 为-1
    - batch Update 批量更新群组中所有成员的群组人员信息，将当前退出群聊的人员信息进行剔除；
  - leader选定：重新选择群主
    - 查询群组成员加入时间，按照先加入原则，update 该成员为群主；
      
      ## 16. Q 查看用户信息
      
      POST/imSession/queryUserInfo
- 使用场景：
  - 查询当前会话用户信息；
  - 接口通用：可查询会话成员基本信息；
- 接口逻辑：
  - 查询会话成员详情
  - if 会话信息不存在
    - throw Exception 提示会话信息不存在
  - else 会议信息存在
    - 返回对象将会员信息set 到返回对象的Data中。
      
      ## 17. Q 会话消息查询
      
      POST/imSession/history
- **使用场景**
  - 查询当前会话人的聊天记录；暂定查询10天内聊天记录；
- 接口返回 data中数据为10天的聊天list

# 通讯录

## 1. 打开通讯录：专门用于打开联系人时使用

POST/contacts/openAddressBook

## 2. 查看联系人：在通讯录里选中一个联系人时查看这个联系人的更多信息

POST/contacts/lookOver
通讯录（联系人）类型判定表 

| 类型  | localId | targetId | imSession | option   |
| --- | ------- | -------- | --------- | -------- |
| 好友  | 有值      | 有值       | 无值        | 删除好友，发消息 |
| 同事  | 无值      | 有值       | 无值        | 添加好友，发消息 |
| 私聊  | 有值      | 有值       | 有值        | 添加好友，发消息 |
| 群聊  | 不定      | 无值       | 有值        | 推出群聊，发消息 |

## 3. 获取联系人：获取已有联系人列表，包括组织联系人

POST/contacts/getList

## 4. 添加联系人：添加私有联系人（好友）组织内可见成员自动验证

POST/contacts/addContacts

## 5. 验证联系人：验证联系人申请，可以拒绝

POST/contacts/verContacts

## 6. 查找联系人：用于通过手机号精准获取联系人

POST/contacts/seekContacts

## 7. 删除联系人：同时在双方联系人列表中删除

POST/contacts/delContacts

## 8. 关注联系人：对私有联系人（好友）加关注

POST/contacts/setFavorite

## 9. 拉黑联系人：（暂时不实现）在双方联系人列表中删除，且对方不可再发添加申请

POST/contacts/hitContacts

时序图

关系图ER