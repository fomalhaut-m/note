# 搞懂 TCP

> 理解 TCP三次握手、四次挥手过程及原理

## TCP 协议简述

TCP 提供面向有连接的通信传输，面向有连接是指在传送数据之前必须先建立连接，数据传送完成后要释放连接。

无论哪一方向另一方发送数据之前，都必须先在双方之间建立一条连接。在TCP/IP协议中，TCP协议提供可靠的连接服务，连接是通过三次握手进行初始化的。同时由于TCP协议是一种面向连接的、可靠的、基于字节流的运输层通信协议，TCP是全双工模式，所以需要四次挥手关闭连接。

## TCP包首部

网络中传输的数据包由两部分组成：一部分是协议所要用到的首部，另一部分是上一层传过来的数据。首部的结构由协议的具体规范详细定义。在数据包的首部，明确标明了协议应该如何读取数据。反过来说，看到首部，也就能够了解该协议必要的信息以及所要处理的数据。包首部就像协议的脸。

所以我们在学习TCP协议之前，首先要知道TCP在网络传输中处于哪个位置，以及它的协议的规范，下面我们就看看TCP首部的网络传输起到的作用：

下面的图是TCP头部的规范定义，它定义了TCP协议如何读取和解析数据：

![](<../../.gitbook/assets/图片 (3).png>)



* TCP首部承载这TCP协议需要的各项信息，下面我们来分析一下：

<figure><img src="../../.gitbook/assets/图片 (2) (1).png" alt=""><figcaption></figcaption></figure>

### TCP端口号

* TCP的连接是需\`要四个要素确定唯一一个连接： （源IP，源端口号）+ （目地IP，目的端口号）
* 所以TCP首部\` 预留了两个16位作为端口号的存储，而IP地址由上一层IP协议负责传递源端口号和目地端口各占16位两个字节，也就是端口的范围是2^16=65535另外1024以下是系统保留的，从1024-65535是用户使用的端口范围

### TCP的序号和确认号：

* 32位序号 seq：Sequence number 缩写seq ，TCP通信过程中某一个传输方向上的字节流的每个字节的序号，通过这个来确认发送的数据有序，比如现在序列号为1000，发送了1000，下一个序列号就是2000。
* 32位确认号 ack：Acknowledge number 缩写ack，TCP对上一次seq序号做出的确认号，用来响应TCP报文段，给收到的TCP报文段的序号seq加1。

### TCP的标志位

> 每个TCP段都有一个目的，这是借助于TCP标志位选项来确定的，允许发送方或接收方指定哪些标志应该被使用，以便段被另一端正确处理。 用的最广泛的标志是 SYN，ACK 和 FIN，用于建立连接，确认成功的段传输，最后终止连接。

* `SYN`：简写为`S`，同步标志位，用于建立会话连接，同步序列号；
* `ACK`：简写为`.`，确认标志位，对已接收的数据包进行确认；
* `FIN`：简写为`F`，完成标志位，表示我已经没有数据要发送了，即将关闭连接；
* `PSH`：简写为`P`，推送标志位，表示该数据包被对方接收后应立即交给上层应用，而不在缓冲区排队；
* `RST`：简写为`R`，重置标志位，用于连接复位、拒绝错误和非法的数据包；
* `URG`：简写为`U`，紧急标志位，表示数据包的紧急指针域有效，用来保证连接不被阻断，并督促中间设备尽快处理；

## 三次握手

所谓三次握手(Three-way Handshake)，是指建立一个 TCP 连接时，需要客户端和服务器总共发送3个报文。

三次握手的目的是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换 TCP 窗口大小信息。在 socket 编程中，客户端执行 connect() 时。将触发三次握手。

三次握手过程的示意图如下：&#x20;

<figure><img src="../../.gitbook/assets/图片 (3) (1).png" alt=""><figcaption></figcaption></figure>

### 报文分析

1. 第一次握手：

客户端将TCP报文标志位`SYN`置为`1`，随机产生一个序号值`seq=J`，保存在TCP首部的序列号(Sequence Number) 字段里，指明客户端打算连接的服务器的端口，并将该数据包发送给服务器端，发送完毕后，客户端进入`SYN_SENT`状态，等待服务器端确认。

```
No.     Time        Source      Destination Protocol    Length      Info                                                              
1486	36.928643	127.0.0.1	127.0.0.1	TCP         56          59117 → 9010 [SYN] Seq=0 Win=65535 Len=0 MSS=65495 WS=256 SACK_PERM              > 分析: 第一次握手                                                                                                            
```

2. 第二次握手：

服务器端收到数据包后由标志位`SYN=1`知道客户端请求建立连接，服务器端将TCP报文标志位`SYN`和`ACK`都置为`1`，`ack=J+1` ，随机产生一个序号值`seq=K`，并将该数据包发送给客户端以确认连接请求，服务器端进入`SYN_RCVD`状态。

```
No.     Time        Source      Destination Protocol    Length      Info
1487	36.928672	127.0.0.1	127.0.0.1	TCP         56          9010 → 59117 [SYN, ACK] Seq=0 Ack=1 Win=65535 Len=0 MSS=65495 WS=256 SACK_PERM   > 分析: 第二次握手                                                                                                                                   
```

3. 第三次握手：

客户端收到确认后，检查`ack`是否为`J+1`，`ACK`是否为1，如果正确则将标志位`ACK`置为`1`，`ack=K+1` ，并将该数据包发送给服务器端，服务器端检查`ack`是否为`K+1`，`ACK`是否为`1` ，如果正确则连接建立成功，客户端和服务器端进入`ESTABLISHED`状态，完成三次握手，随后客户端与服务器端之间可以开始传输数据了。

```
No.     Time        Source      Destination Protocol    Length      Info
1488	36.928696	127.0.0.1	127.0.0.1	TCP         44          59117 → 9010 [ACK] Seq=1 Ack=1 Win=2161152 Len=0                                 > 分析: 第三次握手                                                                         
```

4. 建立连接后，客户端发送http请求

```
No.     Time        Source      Destination Protocol    Length      Info
1489	36.928893	127.0.0.1	127.0.0.1	HTTP        639         GET /gc/ws/stomp HTTP/1.1                                                        > 分析: 建立连接后，客户端发送http请求                          
```

## 为什么需要三次握手？

*

我们假设client发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达server。本来这是一个早已失效的报文段。但server收到此失效的连接请求报文段后，就误认为是client再次发出的一个新的连接请求。于是就向client发出确认报文段，同意建立连接。

*

假设不采用“三次握手”，那么只要server发出确认，新的连接就建立了。由于现在client并没有发出建立连接的请求，因此不会理睬server的确认，也不会向server发送数据。但server却以为新的运输连接已经建立，并一直等待client发来数据。这样，server的很多资源就白白浪费掉了。

* 所以，采用“三次握手”的办法可以防止上述现象发生。例如刚才那种情况，client不会向server的确认发出确认。server由于收不到确认，就知道client并没有要求建立连接。
* TCP 三次握手跟现实生活中的人与人打电话是很类似的：

> 三次握手： “喂，你听得到吗？” “我听得到呀，你听得到我吗？” “我能听到你，今天 balabala……“

经过三次的互相确认，大家就会认为对方对听的到自己说话，并且愿意下一步沟通，否则，对话就不一定能正常下去了。

## TCP 四次挥手关闭连接

四次挥手即终止TCP连接，就是指断开一个TCP连接时，需要客户端和服务端总共发送4个包以确认连接的断开。在socket编程中，这一过程由客户端或服务端任一方执行close来触发。由于TCP连接是全双工的，因此，每个方向都必须要单独进行关闭，这一原则是当一方完成数据发送任务后，发送一个FIN来终止这一方向的连接，收到一个FIN只是意味着这一方向上没有数据流动了，即不会再收到数据了，但是在这个TCP连接上仍然能够发送数据，直到这一方向也发送了FIN。首先进行关闭的一方将执行主动关闭，而另一方则执行被动关闭。

四次挥手过程的示意图如下：

<figure><img src="../../.gitbook/assets/图片 (4).png" alt=""><figcaption></figcaption></figure>

1. 第一次挥手：

Client端发起挥手请求，向Server端发送标志位是FIN报文段，设置序列号seq，此时，Client端进入FIN\_WAIT\_1状态，这表示Client端没有数据要发送给Server端了。

```csv
No.     Time        Source      Destination Protocol    Length      Info             
2918	86.717613	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [FIN, ACK] Seq=1226 Ack=1414 Win=2159872 Len=0                      > 分析: 第一次挥手
```

2. 第二次分手：

Server端收到了Client端发送的FIN报文段，向Client端返回一个标志位是ACK的报文段，ack设为seq加1，Client端进入FIN\_WAIT\_2状态，Server端告诉Client端，我确认并同意你的关闭请求。

```csv
No.     Time        Source      Destination Protocol    Length      Info             
2919	86.717626	127.0.0.1	127.0.0.1	TCP         44          59117 → 9010 [ACK] Seq=1414 Ack=1227 Win=2159872 Len=0                           > 分析: 第二次分手
```

3. 第三次分手：

Server端向Client端发送标志位是FIN的报文段，请求关闭连接，同时Client端进入LAST\_ACK状态。

```csv
No.     Time        Source      Destination Protocol    Length      Info             
2920	86.717668	127.0.0.1	127.0.0.1	TCP         44          59117 → 9010 [FIN, ACK] Seq=1414 Ack=1227 Win=2159872 Len=0                      > 分析: 第三次分手
```

4. 第四次分手：

Client端收到Server端发送的FIN报文段，向Server端发送标志位是ACK的报文段，然后Client端进入TIME\_WAIT状态。Server端收到Client端的ACK报文段以后，就关闭连接。此时，Client端等待2MSL的时间后依然没有收到回复，则证明Server端已正常关闭，那好，Client端也可以关闭连接了。

```csv
No.     Time        Source      Destination Protocol    Length      Info             
2921	86.717681	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [ACK] Seq=1227 Ack=1415 Win=2159872 Len=0                           > 分析: 第四次分手
```

### 附件报文

```csv
No.     Time        Source      Destination Protocol    Length      Info                                                                               分析
1486	36.928643	127.0.0.1	127.0.0.1	TCP         56          59117 → 9010 [SYN] Seq=0 Win=65535 Len=0 MSS=65495 WS=256 SACK_PERM              > 分析: 第一次握手
1487	36.928672	127.0.0.1	127.0.0.1	TCP         56          9010 → 59117 [SYN, ACK] Seq=0 Ack=1 Win=65535 Len=0 MSS=65495 WS=256 SACK_PERM   > 分析: 第二次握手
1488	36.928696	127.0.0.1	127.0.0.1	TCP         44          59117 → 9010 [ACK] Seq=1 Ack=1 Win=2161152 Len=0                                 > 分析: 第三次握手
1489	36.928893	127.0.0.1	127.0.0.1	HTTP        639         GET /gc/ws/stomp HTTP/1.1                                                        > 分析: 建立连接后，客户端发送http请求
1614	39.619573	127.0.0.1	127.0.0.1	WebSocket   116         WebSocket Text [FIN] [MASKED]                                                    >
1615	39.619604	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [ACK] Seq=624 Ack=1079 Win=2160128 Len=0                            >
1701	42.662700	127.0.0.1	127.0.0.1	WebSocket   68          WebSocket Text [FIN] [MASKED]                                                    >
1702	42.662736	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [ACK] Seq=624 Ack=1103 Win=2160128 Len=0                            >
1760	46.937469	127.0.0.1	127.0.0.1	WebSocket   53          WebSocket Text [FIN] [MASKED]                                                    >
1761	46.937544	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [ACK] Seq=624 Ack=1112 Win=2160128 Len=0                            >
1880	52.452378	127.0.0.1	127.0.0.1	WebSocket   217         WebSocket Text [FIN] [MASKED]                                                    >
1881	52.452407	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [ACK] Seq=624 Ack=1285 Win=2159872 Len=0                            >
1908	52.637561	127.0.0.1	127.0.0.1	WebSocket   49          WebSocket Text [FIN]                                                             >
1909	52.637639	127.0.0.1	127.0.0.1	TCP         44          59117 → 9010 [ACK] Seq=1285 Ack=629 Win=2160640 Len=0                            >
1996	56.941952	127.0.0.1	127.0.0.1	WebSocket   53          WebSocket Text [FIN] [MASKED]                                                    >
1997	56.942029	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [ACK] Seq=629 Ack=1294 Win=2159872 Len=0                            >
2219	62.644045	127.0.0.1	127.0.0.1	WebSocket   49          WebSocket Text [FIN]                                                             >
2220	62.644104	127.0.0.1	127.0.0.1	TCP         44          59117 → 9010 [ACK] Seq=1294 Ack=634 Win=2160640 Len=0                            >
2357	66.464140	127.0.0.1	127.0.0.1	WebSocket   58          WebSocket Text [FIN] [MASKED]                                                    >
2358	66.464166	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [ACK] Seq=634 Ack=1308 Win=2159872 Len=0                            >
2381	66.942044	127.0.0.1	127.0.0.1	WebSocket   53          WebSocket Text [FIN] [MASKED]                                                    >
2382	66.942123	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [ACK] Seq=634 Ack=1317 Win=2159872 Len=0                            >
2446	69.212869	127.0.0.1	127.0.0.1	WebSocket   94          WebSocket Text [FIN] [MASKED]                                                    >
2447	69.212900	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [ACK] Seq=634 Ack=1367 Win=2159872 Len=0                            >
2532	72.659134	127.0.0.1	127.0.0.1	WebSocket   49          WebSocket Text [FIN]                                                             >
2533	72.659151	127.0.0.1	127.0.0.1	TCP         44          59117 → 9010 [ACK] Seq=1367 Ack=639 Win=2160640 Len=0                            >
2628	76.951055	127.0.0.1	127.0.0.1	WebSocket   53          WebSocket Text [FIN] [MASKED]                                                    >
2629	76.951076	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [ACK] Seq=639 Ack=1376 Win=2159872 Len=0                            >
2798	82.468524	127.0.0.1	127.0.0.1	WebSocket   572         WebSocket Text [FIN]                                                             >
2799	82.468544	127.0.0.1	127.0.0.1	TCP         44          59117 → 9010 [ACK] Seq=1376 Ack=1167 Win=2160128 Len=0                           >
2800	82.468620	127.0.0.1	127.0.0.1	WebSocket   68          WebSocket Text [FIN]                                                             >
2801	82.468626	127.0.0.1	127.0.0.1	TCP         44          59117 → 9010 [ACK] Seq=1376 Ack=1191 Win=2160128 Len=0                           >
2906	86.713346	127.0.0.1	127.0.0.1	WebSocket   76          WebSocket Text [FIN] [MASKED]                                                    >
2907	86.713378	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [ACK] Seq=1191 Ack=1408 Win=2159872 Len=0                           >
2912	86.714785	127.0.0.1	127.0.0.1	WebSocket   75          WebSocket Text [FIN]                                                             >
2913	86.714830	127.0.0.1	127.0.0.1	TCP         44          59117 → 9010 [ACK] Seq=1408 Ack=1222 Win=2159872 Len=0                           >
2914	86.717164	127.0.0.1	127.0.0.1	WebSocket   50          WebSocket Connection Close [FIN] [MASKED]                                        >
2915	86.717178	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [ACK] Seq=1222 Ack=1414 Win=2159872 Len=0                           >
2916	86.717294	127.0.0.1	127.0.0.1	WebSocket   48          WebSocket Connection Close [FIN]                                                 >
2917	86.717309	127.0.0.1	127.0.0.1	TCP         44          59117 → 9010 [ACK] Seq=1414 Ack=1226 Win=2159872 Len=0                           >
2918	86.717613	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [FIN, ACK] Seq=1226 Ack=1414 Win=2159872 Len=0                      > 分析: 第一次挥手
2919	86.717626	127.0.0.1	127.0.0.1	TCP         44          59117 → 9010 [ACK] Seq=1414 Ack=1227 Win=2159872 Len=0                           > 分析: 第二次分手
2920	86.717668	127.0.0.1	127.0.0.1	TCP         44          59117 → 9010 [FIN, ACK] Seq=1414 Ack=1227 Win=2159872 Len=0                      > 分析: 第三次分手
2921	86.717681	127.0.0.1	127.0.0.1	TCP         44          9010 → 59117 [ACK] Seq=1227 Ack=1415 Win=2159872 Len=0                           > 分析: 第四次分手
```
